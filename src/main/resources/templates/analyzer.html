<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Sirius</title>
    <meta name="description" content="Описание страницы"/>
    <meta name="keywords" content="ключевые слова, фразы"/>

    <!-- Styles -->
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}"/>
    <link rel="stylesheet" th:href="@{/css/reset.css}"/>
    <link rel="stylesheet" th:href="@{/css/base.css}"/>
    <link rel="stylesheet" th:href="@{/css/main.css}"/>

    <!-- Web fonts -->
    <link rel="stylesheet" th:href="@{/css/fonts/sofia-pro/stylesheet.css}"/>
    <link rel="stylesheet" th:href="@{/css/fonts/circular/stylesheet.css}"/>

    <!-- Open Graph -->
    <meta property="og:type" content="website"/>
    <meta property="og:title" content="Приложение для курсового проекта"/>
    <meta property="og:description" content="Система продажи цифрового контента"/>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" th:href="@{/img/favicon/apple-touch-icon.png}"/>
    <link rel="icon" type="image/png" sizes="32x32" th:href="@{/img/favicon/favicon-32x32.png}"/>
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/img/favicon/favicon-16x16.png}"/>
    <link rel="manifest" th:href="@{/img/favicon/site.webmanifest}"/>
    <link rel="mask-icon" th:href="@{/img/favicon/safari-pinned-tab.svg}" color="#1a60cf"/>
    <link rel="shortcut icon" th:href="@{/img/favicon/favicon.ico}"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <meta name="theme-color" content="#ffffff"/>
</head>
<body>

<main style="width: 100%;">
    <div th:insert="~{fragments/uaNavbar.html}" sec:authorize="!isAuthenticated()"></div>
    <div th:insert="~{fragments/aNavbar.html}" sec:authorize="isAuthenticated() && hasAuthority('USER')"></div>
    <div th:insert="~{fragments/adminNavbar.html}" sec:authorize="isAuthenticated() && hasAuthority('ADMIN')"></div>
    <div class="container" style="display: flex; align-items: center; justify-content: center; flex-direction: column">
        <div class="alert alert-success" style="transition: 0.4s ease-in-out" id="output">
            Number recognition tool
        </div>
        <canvas style="border: 1px solid black; " id="canvas"></canvas>
        <div style="width: 50%; display: flex; align-items: center; justify-content: center; gap: 50px; padding: 50px">
            <button class="btn btn-success" id="analyze">analyze</button>
            <button class="btn btn-danger" onclick="resize()"> clear</button>
        </div>
    </div>


    <script>
        // wait for the content of the window element
        // to load, then performs the operations.
        // This is considered best practice.

        document.querySelector('#analyze')
            .addEventListener('click', async () => {
                var canvas = document.getElementById("canvas");
                var dataURL = canvas.toDataURL("image/png");
                fetchDataUrl(dataURL);

            })

        let output = document.querySelector('#output');


        window.addEventListener('load', () => {
            resize(); // Resizes the canvas once the window loads
            document.addEventListener('mousedown', startPainting);
            document.addEventListener('mouseup', stopPainting);
            document.addEventListener('mousemove', sketch);
            window.addEventListener('resize', resize);
        });

        const canvas = document.querySelector('#canvas');

        // Context for the canvas for 2 dimensional operations
        const ctx = canvas.getContext('2d');

        // Resizes the canvas to the available size of the window.
        function resize() {

            ctx.canvas.width = 280;
            ctx.canvas.height = 280;

            ctx.fillStyle = "#000000";

            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height)
        }

        const fetchDataUrl = async (dataUrl) => {
            return await fetch(window.origin + "/ai/image", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    "bytes": dataUrl
                })
            })
                .then(response => response.json())
                .then(json => {
                    output.innerHTML = `Your number looks like: <b>${ json['number']} </b>`
                    resize();
                })
        }


        // Stores the initial position of the cursor
        let coord = {x: 0, y: 0};

        // This is the flag that we are going to use to
        // trigger drawing
        let paint = false;

        // Updates the coordianates of the cursor when
        // an event e is triggered to the coordinates where
        // the said event is triggered.
        function getPosition(event) {
            coord.x = event.clientX - canvas.offsetLeft;
            coord.y = event.clientY - canvas.offsetTop;
        }

        // The following functions toggle the flag to start
        // and stop drawing
        function startPainting(event) {
            paint = true;
            getPosition(event);
        }

        function stopPainting() {
            paint = false;
        }

        function sketch(event) {
            if (!paint) return;
            ctx.beginPath();

            ctx.lineWidth = 50;

            // Sets the end of the lines drawn
            // to a round shape.
            ctx.lineCap = 'round';

            ctx.strokeStyle = 'white';


            // The cursor to start drawing
            // moves to this coordinate
            ctx.moveTo(coord.x, coord.y);

            // The position of the cursor
            // gets updated as we move the
            // mouse around.
            getPosition(event);

            // A line is traced from start
            // coordinate to this coordinate
            ctx.lineTo(coord.x, coord.y);

            // Draws the line.
            ctx.stroke();
        }
    </script>
</main>

</body>
</html>